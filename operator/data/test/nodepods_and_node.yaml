global:
  evaluation_interval: 10s
scrape_configs:
  - job_name: node_exporter
    scrape_interval: 60s
    static_config:
      targets:
        - localhost:9100
      scheme: http
      labels:
        node_id: "this_server"
  - job_name: k8pods
    scrape_interval: 60s
    scrape_timeout: 10s
    scheme: http
    kubernetes_sd_configs:
      - role: pod
        kubeconfig_file: KUBECONFIG
        namespaces:
          names:
            - default
        selectors:
          - role: pod
            field: spec.nodeName=test
    relabel_configs:
      # only keep pods that have the \"monitoring.stackable.tech/should_be_scraped = true\" annotation.
      - source_labels: [__meta_kubernetes_pod_annotation_monitoring_stackable_tech_should_be_scraped]
        regex: true
        action: keep
      # only keep discovered pods with the container_port_name 'metrics'
      # this avoids to discover other controller_port (e.g. clientPort in ZooKeeper)
      - source_labels: [__meta_kubernetes_pod_container_port_name]
        action: keep
        regex: metrics
      # do not scrape yourself
      - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_name]
        regex: monitoring
        action: drop
      # adapt port to provided pod container port
      - source_labels: [__address__, __meta_kubernetes_pod_container_port_number]
        action: replace
        regex: ([^:]+)(?::\\d+)?;(\\d+)
        replacement: $1:$2
        target_label: __address__
      # use all provided pod labels
      - action: labelmap
        regex: __meta_kubernetes_pod_label_(.+)
      - source_labels: [__meta_kubernetes_namespace]
        action: replace
        target_label: kubernetes_namespace
      - source_labels: [__meta_kubernetes_pod_name]
        action: replace
        target_label: kubernetes_pod_name
      - source_labels: [__meta_kubernetes_pod_node_name]
        action: replace
        target_label: kubernetes_pod_node_name
      - source_labels: [__meta_kubernetes_pod_host_ip]
        action: replace
        target_label: kubernetes_pod_host_ip
      - source_labels: [__meta_kubernetes_pod_uid]
        action: replace
        target_label: kubernetes_pod_uid
      - source_labels: [__meta_kubernetes_pod_controller_kind]
        action: replace
        target_label: kubernetes_pod_controller_kind
      - source_labels: [__meta_kubernetes_pod_controller_name]
        action: replace
        target_label: kubernetes_pod_controller_name"